---
title: "Untitled"
format: html
editor: visual
---

```{r}
library(haven)
library(tidyverse)
```

```{r}
sleep <- read_xpt("SLQ_J.XPT")
diet_intake <- read_xpt("DR1IFF_J.XPT")
diet_total <- read_xpt("DR1TOT_J.XPT")
demo <- read_xpt("DEMO_J.XPT")
```

```{r}
# Exploration of missing data 

# Start with total number of participants with sleep data
sleep %>% pull(SEQN) %>% length()
# N = 6161

# Filter out participants with missing data on sleep duration
temp1 = sleep %>% filter(!is.na(SLD012)) %>% filter(!is.na(SLD013))
temp1 %>% pull(SEQN) %>% length()
# N = 6090

# Filter out participants with missing data on overly-sleepiness and consulting a doctor
temp2 = temp1 %>% filter(!is.na(SLQ050)) %>% filter(SLQ050 != 9) %>% filter(SLQ050 != 7) 
temp3 = temp2 %>% filter(!is.na(SLQ120)) %>% filter(SLQ120 != 9) %>% filter(SLQ120 != 7) 
temp3 %>% pull(SEQN) %>% length()
temp4 = temp3 %>% pull(SEQN)
# N = 6076

# Filter out participants with missing data on macronutrient intake
temp5 = diet_total %>% filter(!is.na(DR1TKCAL)) %>% filter(!is.na(DR1TPROT)) %>% 
  filter(!is.na(DR1TCARB)) %>% filter(!is.na(DR1TTFAT)) %>% filter(!is.na(DR1TFIBE)) 
temp6 = temp5 %>% pull(SEQN) %>% intersect(temp4) 
temp6 %>% length()
# N = 5201

# Filter out participants with missing data on timing of deitary intake
temp7 = diet_intake %>% group_by(SEQN) %>% slice(1) %>% filter(!is.na(DR1_020)) 
temp8 = diet_intake %>% group_by(SEQN) %>% slice(n()) %>% filter(!is.na(DR1_020))
temp9 = temp6 %>% intersect(temp7 %>% pull(SEQN)) %>% intersect(temp8 %>% pull(SEQN))
temp9 %>% length()
# N = 5200

```

```{r}
#histograms of sleep hours on weekdays vs weekends.SLD012 represents week days and SLD013 weekends.
sleep |> 
  select(c(SEQN, SLD012, SLD013)) |>
  pivot_longer(cols = c('SLD012', 'SLD013'),
               names_to = 'period',
               values_to = 'hours') |>
  ggplot(aes(x = hours, fill = period)) + geom_histogram(bins = 24) + facet_grid(period~.) +
  theme(legend.position = 'none')
```

```{r}
# Histogram of total daily calorie intake, stratified by gender

# Merge in gender data
merged_diet <- diet_total %>%
  left_join(select(demo, SEQN, RIAGENDR), by = "SEQN")
merged_diet <- merged_diet[!is.na(merged_diet$DR1TKCAL), ]

merged_diet %>%
  ggplot(aes(x = DR1TKCAL, fill = factor(RIAGENDR))) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 30) + 
  labs(
    x = "Energy Intake (Kcal)",
    y = "Frequency",
    title = "KCAL Intake Stratified by Sex"
  ) +
  theme_minimal() +
  scale_fill_manual(
    values = c("red", "blue"),
    labels = c("Male", "Female") 
  ) +
  labs(fill = "Gender")
```

```{r}
# Histogram of macronutrient intake, stratified by gender

# Filter out rows with missing values
filtered_diet <- merged_diet %>%
  filter(!is.na(DR1TPROT) & !is.na(DR1TCARB) & !is.na(DR1TTFAT) & !is.na(DR1TFIBE) & !is.na(RIAGENDR))

# Reshape the data to a long format
long_diet <- filtered_diet %>%
  select(DR1TPROT, DR1TCARB, DR1TTFAT, DR1TFIBE, RIAGENDR) %>%
  pivot_longer(
    cols = c(DR1TPROT, DR1TCARB, DR1TTFAT, DR1TFIBE),
    names_to = "Category",
    values_to = "Value"
  )

ggplot(long_diet, aes(x = Value, fill = factor(RIAGENDR))) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 30) +
  facet_wrap(~ Category, nrow = 2, ncol = 2, scales = "free",
             labeller = as_labeller(c(DR1TPROT = "Protein", DR1TCARB = "Carbohydrate", 
                                      DR1TTFAT = "Total Fat", DR1TFIBE = "Dietary Fiber"))) +
  labs(
    x = "Values (g)",
    y = "Frequency",
    title = "Macronutrient Intake Stratified by Sex",
    fill = "Gender"
    
  ) +
  scale_fill_manual(
    values = c("red", "blue"),
    labels = c("Male", "Female")
  ) +
  theme_minimal()
```
